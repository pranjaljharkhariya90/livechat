<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permanent P2P Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            height: 100vh; display: flex; justify-content: center; align-items: center;
            font-family: 'Segoe UI', sans-serif; color: white;
        }
        
        #chat-card {
            width: 95%; max-width: 800px; height: 85vh;
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #header { padding: 15px 25px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1); }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        /* Chat Bubbles */
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 75%; position: relative; font-size: 15px; }
        .sent { background: #0084ff; align-self: flex-end; border-bottom-right-radius: 2px; }
        .received { background: rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 2px; }
        
        .time { font-size: 10px; opacity: 0.6; display: block; margin-top: 5px; text-align: right; }

        #input-row { padding: 15px; background: rgba(0,0,0,0.4); display: flex; gap: 10px; }
        input { flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 12px; border-radius: 10px; color: white; outline: none; }
        button { padding: 10px 20px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-connect { background: #2ecc71; color: #000; }
        .btn-send { background: #00d2ff; color: #000; }
    </style>
</head>
<body>

<div id="chat-card">
    <div id="header">
        <h3 id="title">Crystal Chat</h3>
        <p id="my-id-display" style="font-size: 12px; color: #00d2ff; cursor: pointer;">Assigning Permanent ID...</p>
    </div>

    <div id="messages"></div>
    
    <div id="input-row">
        <input type="text" id="target-id" placeholder="Friend's Permanent ID...">
        <button class="btn-connect" id="connect-btn">Link</button>
    </div>

    <div id="input-row" style="background: rgba(0,0,0,0.6);">
        <input type="text" id="msg-input" placeholder="Type a message...">
        <button class="btn-send" id="send-btn">Send</button>
    </div>
</div>

<script>
    const messagesDiv = document.getElementById('messages');
    const msgInput = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');
    const connectBtn = document.getElementById('connect-btn');
    const targetIdInput = document.getElementById('target-id');
    const myIdDisplay = document.getElementById('my-id-display');

    // --- 1. HANDLE PERMANENT ID ---
    // Look for a saved ID, if not, create a random string
    let savedID = localStorage.getItem('my_p2p_id');
    if (!savedID) {
        savedID = 'user-' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('my_p2p_id', savedID);
    }

    // Initialize Peer with the FIXED ID
    const peer = new Peer(savedID); 
    let conn;

    // --- 2. LOAD CHAT HISTORY ---
    window.onload = () => {
        const history = JSON.parse(localStorage.getItem('chat_history')) || [];
        history.forEach(m => renderMessage(m.user, m.text, m.type, m.time));
        myIdDisplay.innerText = "Your Permanent ID: " + savedID + " (Click to copy)";
    };

    myIdDisplay.onclick = () => {
        navigator.clipboard.writeText(savedID);
        alert("ID Copied! Share this with your friend.");
    };

    // Handling connections
    peer.on('connection', (connection) => {
        conn = connection;
        setupChat();
    });

    connectBtn.onclick = () => {
        conn = peer.connect(targetIdInput.value);
        setupChat();
    };

    function setupChat() {
        conn.on('data', (data) => {
            saveAndRender("Friend", data.text, "received", data.time);
        });
    }

    function sendMessage() {
        const text = msgInput.value;
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        if (text && conn) {
            conn.send({ text, time });
            saveAndRender("You", text, "sent", time);
            msgInput.value = '';
        }
    }

    sendBtn.onclick = sendMessage;
    msgInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

    // --- 3. STORAGE LOGIC ---
    function saveAndRender(user, text, type, time) {
        const history = JSON.parse(localStorage.getItem('chat_history')) || [];
        history.push({ user, text, type, time });
        localStorage.setItem('chat_history', JSON.stringify(history));
        renderMessage(user, text, type, time);
    }

    function renderMessage(user, text, type, time) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerHTML = `<strong>${user}</strong><br>${text}<span class="time">${time}</span>`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>
